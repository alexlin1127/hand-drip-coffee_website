<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Alex's Coffee Shop</title>

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous" />

        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
            rel="stylesheet" />

        <link href="style.css" rel="stylesheet" />
        <link href="cart_style.css" rel="stylesheet" />
    </head>

    <body>
        <nav id="head-area" class="navbar navbar-expand-lg navbar-custom fixed-top"></nav>

        <div class="cart-container d-lg-flex justify-content-center">
            <div class="col-12 col-md-6">
                <section class="cart">
                    <h2>訂單明細</h2>
                    <div class="button-section d-flex mb-3">
                        <button class="selectAllItem" id="selectAllItem" onclick="selectAllItem()">全選</button>
                        <button class="removeAllItem" id="removeAllItem" onclick="removeAllItem()">清空購物車</button>
                    </div>
                    <div id="cartItemsContainer"></div> <!--JS插入的內容-->
                </section>

                <section class="checkout">  
                    <div class="total-row">
                        消費金額:<span class="price" id="totalPrice">0</span>元
                    </div>
                    <button class="checkout-btn" id="checkout-btn" onclick="handleCheckout()">
                        結帳 (<span id="itemCount">0</span>)
                    </button>
                </section>
            </div>
        </div>


        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"></script>

        <script src="header.js"></script>
        <script src="updateCartBadge.js"></script>

        <script>
            let cartData = [];

            // 整理購物車內品項，將同品項數量加總
            function loadCartData() {
                let cart = JSON.parse(localStorage.getItem("cart") || []);
                const productCount = {};

                cart.forEach(item => {
                    let key = item.name;
                    if (productCount[key]) {
                        productCount[key].quantity += 1;
                    } else {
                        productCount[key] = {
                            name: item.name,
                            price: item.price,
                            id: item.id,
                            quantity: 1,
                            selected: true,
                        };
                    }
                });

                cartData = [];
                for (let key in productCount) {
                    cartData.push(productCount[key]);
                }
            }

            // 儲存購物車資料
            function saveCartData() {
                let cart = [];
                cartData.forEach(item => {
                    for (let i = 0; i < item.quantity; i++) {
                        cart.push({
                            name: item.name,
                            price: item.price,
                            id: item.id
                        })
                    }
                })
                localStorage.setItem("cart", JSON.stringify(cart));
                if (typeof updateCartBadge === "function") {
                    updateCartBadge(cart);
                }
                console.log("購物車已更新: ", cartData);
            }

            // 渲染購物車的內容
            function renderCartItems() {
                const container = document.getElementById('cartItemsContainer');
                container.innerHTML = '';

                for (let i = 0; i < cartData.length; i++) {
                    const item = cartData[i];
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.innerHTML = 
                        '<div class="item-header">' +
                            '<input class="item-check" type="checkbox" ' + (item.selected ? 'checked' : '') + ' onchange="handleItemToggle(' + i + ', this.checked)">' +
                            '<div class="item-name">' + item.name + '</div>' +
                        '</div>' +
                        '<div class="itemPrice">' +
                            '價格: <span>$' + item.price.toLocaleString() + '</span>' +
                        '</div>' +
                        '<div class="item-controls">' +
                            '<div class="quantity-controls">' +
                                '<button class="quantity-btn" onclick="changeQuantity(' + i + ', -1)" ' + (item.quantity <= 1 ? 'disabled' : '') + '>-</button>' +
                                '<span style="margin: 0 10px;">' + item.quantity + '</span>' +
                                '<button class="quantity-btn" onclick="changeQuantity(' + i + ', 1)">+</button>' +
                            '</div>' +
                            '<div>' +
                                '<button class="delete-btn" onclick="removeItem(' + i + ')">刪除</button>' +
                            '</div>' +
                        '</div>';
                    container.appendChild(div);
                }
            }

            // 全選商品
            function selectAllItem() {
                const itemCheckBox = document.getElementsByClassName('item-check');
                for (let i=0; i < itemCheckBox.length; i++) {
                    console.log(typeof itemCheckBox[i].checked);
                    if (itemCheckBox[i].checked == false) {
                        itemCheckBox[i].checked = true;
                    }
                    cartData[i].selected = true;
                }
                updateTotal();
            }

            // 處理單項選擇
            function handleItemToggle(index, checked) {
                cartData[index].selected = checked;
                updateTotal();
                saveCartData();
            }

            // 修改商品數量
            function changeQuantity(index, change) {
                const item = cartData[index];
                const newQuantity = item.quantity + change;

                if (newQuantity >= 1) {
                    item.quantity = newQuantity;
                    renderCartItems();
                    updateTotal();
                    saveCartData();
                }
            }

            // 移除商品
            function removeItem(index) {
                if (confirm("確定要刪除此商品嗎？")) {
                    cartData.splice(index, 1);
                    renderCartItems();
                    updateTotal();
                    saveCartData();
                }
            }

            // 更新總金額
            function updateTotal() {
                let totalAmount = 0;
                let totalQuantity = 0;

                for (let i = 0; i < cartData.length; i++) {
                    const item = cartData[i];
                    if (item.selected) {
                        totalAmount += item.price * item.quantity;
                        totalQuantity += item.quantity;
                    }
                }

                document.getElementById("totalPrice").textContent = totalAmount.toLocaleString();
                document.getElementById("itemCount").textContent = totalQuantity;
                document.getElementById("checkout-btn").disabled = (totalQuantity === 0);
            }

            // 點選結帳按鈕後的顯示畫面，包含購買多少產品及總金額
            function handleCheckout() {
                let totalAmount = 0;
                let totalQuantity = 0;

                for (let i = 0; i < cartData.length; i++) {
                    const item = cartData[i];
                    if (item.selected) {
                        totalAmount += item.price * item.quantity;
                        totalQuantity += item.quantity;
                    }
                }

                if (totalQuantity > 0) {
                    alert("準備結帳\n總共 " + totalQuantity + " 件商品\n金額：$" + totalAmount.toLocaleString());
                }
            }
            
            // 清除購物車
            function removeAllItem() {
                localStorage.setItem('cart', JSON.stringify([])); // 設為空陣列
                cartData = [];
                renderCartItems();
                updateTotal();
                if (typeof updateCartBadge === "function") {
                    updateCartBadge([]);
                }
            }

            // 頁面載入完成後執行
            window.onload = () => {
                loadCartData();
                renderCartItems();
                updateTotal();
            };
        </script>
    </body>
</html>
